# Bitrix24 Integration Module

Модуль интеграции с Bitrix24 для создания задач из процессов Camunda BPM.

## Описание

Этот модуль обрабатывает сообщения из RabbitMQ очереди `bitrix24.queue` и создает соответствующие задачи в Bitrix24 через REST API.

## Компоненты

- `handler.py` - Основной обработчик сообщений для создания задач в Bitrix24
- `config.py` - Конфигурация специфичная для Bitrix24
- `README.md` - Эта документация

## Конфигурация

### Переменные окружения для Bitrix24

```bash
# Обязательные настройки
BITRIX_WEBHOOK_URL=https://bx.eg-holding.ru/rest/1/123123123123

# Опциональные настройки
BITRIX_DEFAULT_RESPONSIBLE_ID=1
BITRIX_DEFAULT_PRIORITY=2
BITRIX_REQUEST_TIMEOUT=30
BITRIX_MAX_DESCRIPTION_LENGTH=10000
```

## Поддерживаемые топики

- `bitrix_create_task` - Создание новой задачи
- `bitrix_update_task` - Обновление существующей задачи
- `bitrix_create_deal` - Создание новой сделки
- `bitrix_update_deal` - Обновление существующей сделки
- `bitrix_create_contact` - Создание нового контакта
- `bitrix_create_lead` - Создание нового лида
- `bitrix_update_lead` - Обновление существующего лида
- `bitrix_create_company` - Создание новой компании
- `bitrix_update_company` - Обновление существующей компании

## Формат входящих сообщений

Модуль обрабатывает сообщения в формате JSON из Camunda:

```json
{
  "task_id": "abc123",
  "topic": "bitrix_create_task",
  "variables": {
    "title": {"value": "Название задачи"},
    "description": {"value": "Описание задачи"},
    "responsible_id": {"value": "123"},
    "priority": {"value": "2"},
    "deadline": {"value": "2024-12-31 23:59:59"}
  },
  "metadata": {
    "inputParameters": {},
    "outputParameters": {},
    "extensionProperties": {}
  }
}
```

## Извлечение данных

Обработчик извлекает данные из переменных сообщения по следующему приоритету:

### Заголовок задачи
- `title`, `name`, `subject`, `task_title`, `task_name`

### Ответственный
- `responsible_id`, `responsible`, `assignee_id`, `assignee`, `user_id`

### Приоритет
- `priority`, `task_priority`, `urgency`, `importance`
- Поддерживает: числовые значения (1-3) или текстовые ('low', 'normal', 'high')

### Дедлайн
- `deadline`, `due_date`, `end_date`, `task_deadline`

## Пользовательские поля (UF_)

Модуль поддерживает автоматическое извлечение и передачу пользовательских полей из `extensionProperties` в метаданных сообщения.

### Поддерживаемые пользовательские поля

#### UF_RESULT_EXPECTED
- **Тип**: Булево поле (Да/Нет)
- **Назначение**: Индикатор того, ожидается ли результат выполнения задачи
- **Формат в Camunda**: `"true"`, `"false"`, `"1"`, `"0"`, `"да"`, `"нет"`, `"yes"`, `"no"`
- **Формат в Bitrix24**: `"Y"` или `"N"`

#### UF_RESULT_QUESTION
- **Тип**: Строковое поле
- **Назначение**: Вопрос или описание ожидаемого результата
- **Формат**: Текстовая строка (обрезается до непустых значений)

#### UF_ELEMENT_ID
- **Тип**: Строковое поле
- **Назначение**: Сохраняет `elementId` из BPMN диаграммы Storm для каждой созданной задачи Bitrix24
- **Использование**: Позволяет искать существующие задачи по элементу диаграммы и строить связи «предшественник → последователь»
- **Формирование**: Заполняется автоматически при создании задач (как из шаблонов, так и в fallback-режиме)

### Предшественники задач

- BitrixTaskHandler извлекает `diagramId` и `elementId` из метаданных ExternalTask.
- По API `imena.camunda.diagram.responsible.get` запрашивается список `PREDECESSOR_IDS` для текущего элемента диаграммы.
- Для каждого элемента-предшественника выполняется поиск задачи Bitrix24 по `UF_ELEMENT_ID`. Найденные задачи добавляются в поле `SE_PROJECTDEPENDENCE` c типом связи `TYPE = 2` (Finish-Start).
- После успешного создания задачи дополнительно вызывается кастомный REST-метод `imena.camunda.task.dependency.add`, который принудительно создаёт связь `taskId → dependsOnId` (Finish-Start) даже если стандартное поле игнорируется.
- Если задача-предшественник ещё не создана, связь пропускается с предупреждением в логах.
- При создании задач по шаблону и в fallback-режиме поле `UF_ELEMENT_ID` добавляется автоматически, поэтому повторные запуски обработчика корректно выстраивают цепочку зависимостей.

### Пример сообщения с пользовательскими полями

```json
{
  "task_id": "2d0bf3ab-5e83-11f0-a3a6-00b436387543",
  "topic": "bitrix_create_task",
  "variables": {
    "projectManagerId": "3",
    "projectId": "2"
  },
  "metadata": {
    "extensionProperties": {
      "UF_RESULT_EXPECTED": "true",
      "UF_RESULT_QUESTION": "снос объектов по уведомлению требуется?",
      "assigneeId": "15297786"
    },
    "activityInfo": {
      "name": "Выяснить: снос объектов по уведомлению требуется?"
    }
  }
}
```

### Обработка пользовательских полей

1. Модуль автоматически извлекает все поддерживаемые пользовательские поля из `metadata.extensionProperties`
2. Выполняет преобразование типов данных согласно требованиям Bitrix24 API
3. Добавляет поля в запрос создания задачи только если они присутствуют в исходном сообщении
4. Логирует информацию о найденных и обработанных пользовательских полях

### Расширение поддержки

Для добавления поддержки новых пользовательских полей:

1. Добавьте имя поля в список `supported_user_fields` в методе `_extract_user_fields`
2. При необходимости добавьте специальную обработку типа данных
3. Убедитесь, что поле создано в настройках Bitrix24 для сущности "Задачи" (TASKS_TASK)

## Статистика

Модуль ведет статистику обработки:
- Общее количество сообщений
- Успешно созданные задачи
- Ошибки при создании
- Время работы
- Процент успеха
- Сообщений в минуту

## Логирование

Используется библиотека `loguru` для структурированного логирования всех операций.

## Тестирование

Для тестирования интеграции используйте тестовые скрипты из корневой папки проекта. 