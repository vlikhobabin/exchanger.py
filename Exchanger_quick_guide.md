# Краткое описание работы сервиса:

## Exchanger.py — Описание работы системы

### Назначение
Платформа интеграции Camunda BPM с внешними системами (Bitrix24 и др.) через RabbitMQ. Обеспечивает полный цикл: от получения задач в Camunda до их выполнения во внешних системах и возврата результатов.

---

### Архитектура потока данных

```
┌─────────────┐
│  Camunda    │ ←→ External Tasks
│     BPM     │
└──────┬──────┘
       │
       ↓ (1) Получение External Task
┌─────────────────────┐
│  Camunda Worker     │ → Обогащение метаданными BPMN
│  (camunda_worker.py)│ → Получение переменных процесса
└──────┬──────────────┘
       │
       ↓ (2) Отправка в RabbitMQ
┌─────────────────────┐
│     RabbitMQ        │
│  bitrix24.queue     │
└──────┬──────────────┘
       │
       ↓ (3) Обработка сообщения
┌─────────────────────┐
│  Task Creator       │ → Получение шаблона задачи
│  (handler.py)       │ → Создание задачи в Bitrix24
└──────┬──────────────┘ → Синхронизация с Camunda
       │
       ↓ (4) Задача создана
┌─────────────────────┐
│  bitrix24.sent.queue│
└──────┬──────────────┘
       │
       ↓ (5) Мониторинг статуса
┌─────────────────────┐
│  Task Tracker       │ → Проверка статуса задачи
│  (tracker.py)       │ → Резолвинг пользовательских полей
└──────┬──────────────┘
       │
       ↓ (6) Задача завершена
┌─────────────────────┐
│camunda.responses.   │
│      queue          │
└──────┬──────────────┘
       │
       ↓ (7) Обработка ответа
┌─────────────────────┐
│  Camunda Worker     │ → Завершение External Task
│  (camunda_worker.py)│ → Установка переменных процесса
└──────┬──────────────┘
       │
       ↓ (8) Процесс продолжается
┌─────────────┐
│  Camunda    │ → Следующий этап процесса
│     BPM     │ → Новая External Task (цикл повторяется)
└─────────────┘
```

---

### Детальный flow обработки задачи

#### Этап 1: Получение задачи из Camunda
- Camunda Worker (`camunda_worker.py`) опрашивает Camunda через `fetch_and_lock`
- Получает External Task с данными:
  - `task_id`, `processInstanceId`, `processDefinitionId`
  - `variables` (переменные задачи)
  - `activityId` (ID активности из BPMN)

#### Этап 2: Обогащение метаданными
- Извлечение метаданных BPMN через `BPMNMetadataCache`:
  - `extensionProperties` (assigneeId, пользовательские поля)
  - `activityInfo` (название, описание активности)
  - `processProperties` (свойства процесса)
- Получение переменных процесса через REST API Camunda
- Формирование сообщения для RabbitMQ

#### Этап 3: Отправка в RabbitMQ
- Определение целевой системы по топику (`routing_config`)
- Отправка в очередь (например, `bitrix24.queue`)
- Блокировка задачи в Camunda на время обработки

#### Этап 4: Создание задачи в Bitrix24
- Task Creator (`handler.py`) получает сообщение из очереди
- Проверка идемпотентности: поиск задачи по `UF_CAMUNDA_ID_EXTERNAL_TASK`
- Получение шаблона задачи через API `imena.camunda.tasktemplate.get`
- Формирование данных задачи:
  - Из шаблона: TITLE, DESCRIPTION, RESPONSIBLE_ID, CREATED_BY, DEADLINE, чек-листы, файлы
  - Из метаданных: пользовательские поля (UF_RESULT_EXPECTED, UF_RESULT_QUESTION)
  - Из переменных процесса: блок переменных в описании
- Создание задачи через `tasks.task.add`
- Прикрепление файлов из шаблона
- Создание чек-листов из шаблона
- Синхронизация с Camunda через `imena.camunda.sync`
- Отправка результата в `bitrix24.sent.queue`

#### Этап 5: Отслеживание статуса задачи
- Task Tracker (`tracker.py`) мониторит `bitrix24.sent.queue`
- Периодически проверяет статус задачи в Bitrix24 через `tasks.task.get`
- При завершении (статус 4 или 5):
  - Резолвинг `UF_RESULT_ANSWER` (ID → текст через маппинг)
  - Обновление данных сообщения актуальной информацией
  - Отправка в `camunda.responses.queue` с retry

#### Этап 6: Завершение задачи в Camunda
- Camunda Worker обрабатывает сообщения из `camunda.responses.queue`
- Извлечение данных:
  - `ufResultExpected` — требуется ли ответ
  - `ufResultAnswer_text` — ответ пользователя
- Формирование переменных процесса:
  - Если требуется ответ: `variables[activity_id] = converted_answer` ("ДА"→"ok", "НЕТ"→"no")
  - Если не требуется: `variables[activity_id] = "ok"`
  - Дополнительные переменные: `bitrix_task_id`, `bitrix_task_title`, и т.д.
- Завершение External Task через REST API: `POST /external-task/{id}/complete`
- Camunda получает переменные и продолжает процесс

#### Этап 7: Продолжение процесса
- Camunda оценивает `conditionExpression` с переменной `activity_id`
- Переход к следующему этапу процесса
- Создание новой External Task (цикл повторяется)

---

### Ключевые особенности

1. Идемпотентность: проверка существования задачи по `UF_CAMUNDA_ID_EXTERNAL_TASK` перед созданием
2. Шаблоны задач: использование шаблонов из Bitrix24 API для настройки задач
3. Обогащение метаданными: автоматическое извлечение данных из BPMN диаграмм
4. Резолвинг полей: преобразование ID пользовательских полей в текстовые значения
5. Retry механизмы: повторные попытки при ошибках отправки сообщений
6. Stateless архитектура: задачи не хранятся в памяти, все через очереди

---

### Очереди RabbitMQ

| Очередь | Назначение | Отправитель | Получатель |
|---------|-----------|-------------|------------|
| `bitrix24.queue` | Задачи на создание | Camunda Worker | Task Creator |
| `bitrix24.sent.queue` | Созданные задачи | Task Creator | Task Tracker |
| `camunda.responses.queue` | Завершенные задачи | Task Tracker | Camunda Worker |
| `bitrix24.dead_letter.queue` | Ошибки обработки | Task Tracker | (ручная обработка) |

---

### Компоненты системы

1. Camunda Worker — получение задач из Camunda и отправка в RabbitMQ
2. Task Creator — создание задач во внешних системах
3. Task Tracker — отслеживание статуса задач и отправка результатов
4. BPMN Metadata Cache — кэширование метаданных BPMN диаграмм
5. User Field Sync — синхронизация маппингов пользовательских полей

Это описание можно использовать в документации проекта.